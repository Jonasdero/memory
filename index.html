<html DOCTYPE HTML5>

<head>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

        <script>
                var field = [];
                var width = -1;
                var height = -1;
                var won = -1;
                var playernames = [];
                var players = [];
                var sessionID = -1;
                var pictureUrls = [];
                var interval = null;
                var currentPlayer = -1;
                var playingPlayer = "";
                var points = [];
                var oldfield = [];
                var clicked = false;

                function createTable() {
                        if (document.getElementById("playertable") !== null)
                                $("#playertable").remove();
                        var myTable = document.createElement("table");
                        var mytablehead = document.createElement("thead");
                        currentRow = document.createElement("tr");
                        currentCell = document.createElement("td");
                        currentText = document.createTextNode("Players");
                        currentCell.appendChild(currentText);
                        currentRow.appendChild(currentCell);
                        currentCell = document.createElement("td");
                        currentText = document.createTextNode("Points");
                        currentCell.appendChild(currentText);
                        currentRow.appendChild(currentCell);
                        mytablehead.appendChild(currentRow);
                        var mytablebody = document.createElement("tbody");

                        for (let i = 0; playernames.length > i; i++) {
                                currentRow = document.createElement("tr");
                                currentCell = document.createElement("td");
                                currentText = document.createTextNode(i + 1 + ". " + playernames[i]);
                                currentCell.appendChild(currentText);
                                currentRow.appendChild(currentCell);
                                currentCell = document.createElement("td");
                                currentText = document.createTextNode(points[i]);
                                currentCell.setAttribute("id", "text" + i);
                                currentCell.appendChild(currentText);
                                currentRow.appendChild(currentCell);
                                mytablebody.appendChild(currentRow);
                        }
                        myTable.appendChild(mytablehead);
                        myTable.appendChild(mytablebody);
                        myTable.setAttribute("class", "table");
                        myTable.setAttribute("id", "playertable")
                        document.getElementById("table").appendChild(myTable);
                }

                function makeTable() {
                        node = document.getElementById("game");
                        var myTable = document.createElement("table");
                        var mytablebody = document.createElement("tbody");
                        for (var i = 0; i < height; i++) {
                                currentRow = document.createElement("tr");
                                for (var j = 0; j < width; j++) {
                                        currentCell = document.createElement("td");
                                        currentCell.setAttribute("id", (i * width) + j);
                                        currentCell.innerHTML = '<img src="' + window.location.href + '' + pictureUrls[field[(i * width) + j]] + '" height ="150em" width = "150em" style="margin: 0.5em 0.5em 0.5em 0.5em;"/>';
                                        currentCell.addEventListener("click", function () {                                              
                                                var col = $(this).index();
                                                var row = $(this).closest('tr').index();
                                                var customIndex = (row * width) + col;
                                                if (clicked || field[customIndex] !== 0 || currentPlayer !== sessionID) return;
                                                clicked = true;
                                                $.post("/turn/" + sessionID, { "index": customIndex },
                                                        function (result) {
                                                                clicked = false;
                                                                field = result.field; points = result.points; won = result.won;
                                                        }
                                                );
                                        })
                                        currentRow.appendChild(currentCell);
                                }
                                mytablebody.appendChild(currentRow);
                        }
                        myTable.appendChild(mytablebody);
                        myTable.setAttribute("id", "gametable")
                        node = document.getElementById("table");
                        node.appendChild(myTable);
                }


                function build() {
                        $.get("/game/" + sessionID, function (result) {
                                field = result.field; points = result.points; currentPlayer = result.currentPlayer; won = result.won; playingPlayer = result.playingPlayer;
                                for (let i = 0; i < players.length; i++)
                                        document.getElementById("text" + i).innerText = points[i];
                        })
                        if (currentPlayer !== -1) document.getElementById("playingplayer").innerHTML = playingPlayer + ', it\'s your turn!'
                        else document.getElementById("playingplayer").innerHTML = "Waiting";
                        // if (document.getElementById("gametable") !== null)
                        // $("#gametable").remove();
                        var differences = [];
                        for (let i = 0; i < field.length; i++) {
                                currentCell = document.getElementById(i);
                                if (oldfield[i] != field[i]) {
                                        currentCell.innerHTML = '<img src="' + window.location.href + '' + pictureUrls[field[i]] + '" height ="150em" width = "150em" style="margin: 0.5em 0.5em 0.5em 0.5em;"/>';
                                }
                        }
                        oldfield = field;

                        if (won !== -1) {
                                var index;
                                for (var i = 1; i < points.length; i++) { index = 0; if (points[i] > points[i - 1]) index = i; }
                                clearInterval(interval);
                                alert(playernames[index] + " hat gewonnen");
                        }
                }

                function getConnectedPlayers() {
                        $.get("/connected/" + sessionID,
                                function (result) {
                                        playernames = result.connectedPlayers;
                                        points = []
                                        for (i = 0; i < playernames.length; i++) { points.push(0); }
                                        createTable();
                                }
                        );
                }

                $(document).ready(function () {
                        $("#btn_login").click(function () {
                                if ($("#SName").val() != "" && $("#Session").val() != "" && $("#inputGroupSelect01").val() != "") {
                                        var name = $("#SName").val();
                                        var session = $("#Session").val();
                                        width = parseInt($("#inputGroupSelect01").val().split('x')[0]);
                                        height = parseInt($("#inputGroupSelect01").val().split('x')[1]);

                                        $("#login").hide();
                                        $("#init").show();
                                        $.post("/connect",
                                                { "sessionName": session, "playerName": name, "size": { "width": width, "height": height } },
                                                function (result) {
                                                        sessionID = result.sessionID;
                                                        interval = setInterval(getConnectedPlayers, 300);
                                                }
                                        );

                                } else { $("#warning").show(); }
                        });
                        $("#btn_init").click(function () {
                                $("#ready").hide();
                                $("#game").show();
                                clearInterval(interval);
                                $.get("/init/" + sessionID,
                                        function (result) {
                                                players = result.connectedPlayers;
                                                field = result.field;
                                                pictureUrls = result.pictureUrls;
                                                height = result.height;
                                                width = result.width;
                                                makeTable();
                                                interval = setInterval(build, 300);
                                        }
                                );
                        });
                });
        </script>
</head>

<body>
        <div align=center>
                <h1>Memory</h1>

                <!-- Login Game -->
                <div id="login" class="col-">
                        <form>
                                <div class="form-group">
                                        <label for="PName">Player Name</label>
                                        <input type="text" class="form-control" id="SName" placeholder="Enter Player Name" style="width: 11em;">
                                </div>
                                <div class="form-group">
                                        <label for="Session">Session ID</label>
                                        <input type="text" class="form-control" id="Session" placeholder="Enter Session ID" style="width: 11em;">
                                </div>
                                <div class="input-group mb-3">
                                        <select class="custom-select" id="inputGroupSelect01">
                                                <option value="" selected>Gamesize</option>
                                                <option value="4x4">4x4</option>
                                                <option value="4x5">4x5</option>
                                                <option value="6x6">6x6</option>
                                        </select>
                                </div>
                        </form>
                        <div id="warning" hidden="true" class="bg-danger">Please fill in all fields!</div>
                        <button class="btn btn-primary" id="btn_login">Submit</button>
                </div>

                <!-- Init -->
                <div id="init" hidden="true">
                        <div id="table"></div>
                        <div id="ready">
                                <p>Click ready to start the game</p>
                                <button class="btn btn-primary" id="btn_init">Ready</button>
                        </div>

                </div>

                <!-- Game -->
                <div id="game" hidden="true">
                        <p id="playingplayer"></p>
                </div>
        </div>

</body>

</html>