<html DOCTYPE HTML5>

<head>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

        <script>
                var field = [];
                var width = -1;
                var height = -1;
                var won = -1;
                var players = [];
                var sessionID = -1;
                var pictureUrls = [];
                var interval = null;
                var currentPlayer = -1;
                var points = [];

                function createTable(player, points) {
                        $("#playertable").remove();
                        var myTable = document.createElement("table");
                        var mytablehead = document.createElement("thead");
                        currentRow = document.createElement("tr");
                        currentCell = document.createElement("td");
                        currentText = document.createTextNode("Players");
                        currentCell.appendChild(currentText);
                        currentRow.appendChild(currentCell);
                        currentCell = document.createElement("td");
                        currentText = document.createTextNode("Points");
                        currentCell.appendChild(currentText);
                        currentRow.appendChild(currentCell);
                        mytablehead.appendChild(currentRow);
                        var mytablebody = document.createElement("tbody");

                        for (var i = 0; player.length > i; i++) {
                                currentRow = document.createElement("tr");
                                currentCell = document.createElement("td");
                                currentText = document.createTextNode(i + 1 + ". " + player[i]);
                                currentCell.appendChild(currentText);
                                currentRow.appendChild(currentCell);
                                currentCell = document.createElement("td");
                                currentText = document.createTextNode(points[i]);
                                currentCell.appendChild(currentText);
                                currentRow.appendChild(currentCell);
                                mytablebody.appendChild(currentRow);
                        }
                        myTable.appendChild(mytablehead);
                        myTable.appendChild(mytablebody);
                        myTable.setAttribute("class", "table");
                        myTable.setAttribute("id", "playertable")
                        return myTable;
                }

                function build() {
                        $.get("/game/" + sessionID, function (result) {
                                field = result.field; points = result.points; currentPlayer = result.currentPlayer;
                        })
                        node = document.getElementById("game");
                        if (document.getElementById("gametable") !== null)
                                $("#gametable").remove();
                        var myTable = document.createElement("table");
                        var mytablebody = document.createElement("tbody");
                        for (var i = 0; i < height; i++) {
                                currentRow = document.createElement("tr");
                                for (var j = 0; j < width; j++) {
                                        currentCell = document.createElement("td");
                                        if (currentPlayer === sessionID) currentCell.addEventListener("click", function () {
                                                var $this = $(this);
                                                var col = $this.index();
                                                var row = $this.closest('tr').index();
                                                $.post("/turn/" + sessionID, { "index": (row * width) + col },
                                                        function (result) {
                                                                field = result.field; points = result.points; won = result.won;
                                                        }
                                                );
                                        })
                                        currentCell.innerHTML = '<img src="' + window.location.href + '' + pictureUrls[field[(i * width) + j]] + '" height ="100" width = "100" />';
                                        currentRow.appendChild(currentCell);
                                }
                                mytablebody.appendChild(currentRow);
                        }
                        myTable.appendChild(mytablebody);
                        myTable.setAttribute("id", "gametable")
                        node.appendChild(myTable);
                        if (won !== -1) {
                                var index;
                                for (var i = 1; i < points.length; i++) {
                                        index = 0;
                                        if (points[i] > points[i - 1]) index = i;
                                }
                                clearInterval(interval);
                                alert(player[index] + " hat gewonnen");
                        }
                }

                function getConnectedPlayers() {
                        var players;
                        var points;
                        $.get("/connected/" + sessionID,
                                function (result) {
                                        players = result.connectedPlayers;
                                        var points = []
                                        for (i = 0; i < players.length; i++) { points.push(0); }
                                        node = document.getElementById("table");
                                        node.appendChild(createTable(players, points));
                                }
                        );
                }

                $(document).ready(function () {
                        $("#btn_login").click(function () {
                                if ($("#SName").val() != "" && $("#Session").val() != "" && $("#inputGroupSelect01").val() != "") {
                                        var name = $("#SName").val();
                                        var session = $("#Session").val();
                                        width = parseInt($("#inputGroupSelect01").val().split('x')[0]);
                                        height = parseInt($("#inputGroupSelect01").val().split('x')[1]);

                                        $("#login").hide();
                                        $("#init").show();
                                        $.post("/connect",
                                                { "sessionName": session, "playerName": name, size: { "width": width, "height": height } },
                                                function (result) {
                                                        sessionID = result.sessionID;
                                                        interval = setInterval(getConnectedPlayers, 500);
                                                }
                                        );

                                } else { $("#warning").show(); }
                        });
                        $("#btn_init").click(function () {
                                $("#init").hide();
                                $("#game").show();
                                clearInterval(interval);
                                $.get("/init/" + sessionID,
                                        function (result) {
                                                players = result.connectedPlayers;
                                                field = result.field;
                                                pictureUrls = result.pictureUrls;
                                                interval = setInterval(build, 500);
                                        }
                                );
                        });
                });
        </script>
</head>

<body>
        <h1>Memory</h1>
        <h2>l√∂rrenz</h2>
        <!-- Login Game -->
        <div id="login">
                <form>
                        <div class="form-group">
                                <label for="PName">Player Name</label>
                                <input type="text" class="form-control" id="SName" placeholder="Enter Player Name">
                        </div>
                        <div class="form-group">
                                <label for="Session">Session ID</label>
                                <input type="text" class="form-control" id="Session" placeholder="Enter Session ID">
                        </div>
                        <div class="input-group mb-3">
                                <select class="custom-select" id="inputGroupSelect01">
                                        <option value="" selected>Gamesize</option>
                                        <option value="4x4">4x4</option>
                                        <option value="4x5">4x5</option>
                                        <option value="6x6">6x6</option>
                                </select>
                        </div>
                </form>
                <div id="warning" hidden="true" class="bg-danger">Please fill in all fields!</div>
                <button class="btn btn-primary" id="btn_login">Submit</button>
        </div>

        <!-- Init -->
        <div id="init" hidden="true">
                <div id="table"></div>
                <p>Click ready to start the game</p>
                <button class="btn btn-primary" id="btn_init">Ready</button>
        </div>

        <!-- Game -->
        <div id="game" hidden="true"></div>

</body>

</html>